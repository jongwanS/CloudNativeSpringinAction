# 3. 클라우드 네이티브 개발 시작
> **이 장의 주요 내용**
> - 클라우드 네이티브 프로젝트의 부트스트래핑
> - 임베디드 서버와 톰캣을 사용한 작업
> - 스프링 MVC를 사용한 RESTful 애플리케이션 구축
> - 스프링 테스트를 사용한 RESTful 애플리케이션 테스트
> - 깃허브 액션을 사용한 빌드 및 테스트 자동화

## 3.1 클라우드 네이티브 프로젝트 부트스트래핑
- 15요소 방법론에는 클라우드 네이티브 애플리케이션을 부트스트랩할 때 필요한 몇 가지 실용적인 지침
- **하나의 코드베이스, 하나의 애플리케이션**(one codebase, one application)
  - `클라우드 네이티브 애플리케이션`은 **하나의 코드베이스로 관리**해야 한다.
- **의존성 관리**(dependency management)
  - `클라우드 네이티브 애플리케이션`은 **의존성을 명시적으로 관리하는 도구를 사용**해야 한다.

### 3.1.1 하나의 코드베이스, 하나의 애플리케이션
- `클라우드 네이티브 애플리케이션`은 **단일 코드베이스로 관리**해야 한다.
  - 여러 환경에 배포할 수 있는 **불가변 아티팩트**, 즉 **빌드(build)를 생성**해야 한다.
- `환경에 종속적인 모든 설정`은 애플리케이션 코드베이스의 외부에 있어야 한다.
- `분산된 모놀리스`가 되지 않도록 신중하게 판단해야 한다.
  - 코드가 두 개 이상의 애플리케이션에서 사용된다면, 독립적인 서비스 의존성 라이브러리로 분리해야 한다.

### 3.1.2 그래들과 메이븐의 의존성 관리
- 자바에서 의존성 관리를 ㅜ이해 가장 많이 사용하는 도구는 **그래들**과 **메이븐**이다.
  - `그래들` 및 `메이븐`은 빌드/테스트 등도 제공한다.
- 의존성 매니페스트 파일과 함께 **의존성 관리자**도 있어야 한다.
  - `gradlew`, `mvnw` 라는 **래퍼 스크립트**로 **의존성 관리툴을 실행**할 수 있다.
  - `gradle build` 명령 실행대신 `./gradlew build` 를 실행할 수 있다.
- ````shell
  dependencies {
      implementation 'org.springframework.boot:spring-boot-starter-web'
      testImplementation 'org.springframework.boot:spring-boot-starter-test'
  }
  ````
  - 스프링 웹(spring-boot-starter-web)
    - 스프링 MVC로 웹 애플리케이션을 구축하는 데 필요한 라이브러리 제공
    - 톰캣을 임베디드 서버로 포함하도록 기본설정
    - 의존성 라이브러리 덕분에 개발자는 더 많은 의존성을 관리하지 않아도 된다.
  - 스프링 부트 테스트(spring-boot-starter-test)
    - 스프링 테스트(Spring Test), JUnit, 어서트J, 모키토등 여러 라이브러리 및 유틸리티를 제공한다.

## 3.2 임베디드 서버로 작업
- WAR, EAR로 패키징후 톰캣과 같은 웹서버에 애플리케이션 배포 => `서버에 대한 외부 의존성` 
  - 애플리케이션 자체의 이식성과 발전을 제한
  - 유지 보수 비용 증다 
- 포트 바인딩(port binding)
  - 클라우드 네이티브 애플리케이션은 독립적이고 환경에 따라 설정 가능한 포트로 바인딩해서 서비스를 외부로 제공할 수 있다.
- 동시성(concurrency)
  - 인스턴스를 더 많이 배포해 워크로드를 분산하는 것을 선호한다.

### 3.2.1 실행 가능한 JAR 및 임베디드 서버 
- 전통적인 접근법과 클라우드 네이티브 접근법의 차이점 중 하나는 애플리케이션을 `패키징`하고 `배포`하는 **방법**이다.
  - 전통적 : 애플리케이션 서버나 독립형 웹 서버가 사용됐다. => EAR, WAR 배포
    - 서버 수준에서 무언가 변경해야 한다면, 다른 팀과 조정되어야 하기 때문에 `민첩성`과 `변경`에 **제한**이 있다.
    - 서버 유형에따라 달라질 수 있기 떄문에, `이식성`이 제한된다.
- 클라우드 네이티브 애플리케이션
  - `독립적`이어야 하며, **서버에 의존하지 않는다.**
  - 서버 기능은 `애플리케이션` 자체에 포함되어 조달된다.
    - 스프링 부트 `서버 기능` 내장, **외부 의존성 제거**하고, **독립 실행형**으로 만든다.
    - 스프링 부트에는 `톰캣`서버가 미리 설정되어 번들로 제공되지만, **언더토**, **제티**, **네티**로 대체될 수 있다.
  - `서버 의존성 문제`를 해결 되었으니, 애플리케이션을 패키징하는 방법 역시 변경해야 한다.
    - JVM 생태계에서 클라우드 네이티브 애플리케이션은 `JAR 아티팩트로 패키징`된다.

````bash
# jar 패키징
./gradlew bootJar
# 실행
java -jar build/libs/catalog-service-0.0.1-SNAPSHOT.jar
````

### 3.2.2 요청당 스레드 모델 이해
- `톰캣`과 같은 서블릿 컨테이너에서 실행되는 어플리케이션은 `요청당 스레드(thread-per-request) 모델`을 기반으로 **요청을 처리**한다.
  - 요청에 대한 응답이 클라이언트에 반환될 때까지 이 스레드는 반환되지 않는다.
  - I/O 와 같은 집약적인 작업이 수행되면 이 작업이 완료될 때까지 스레드를 차단한다.
- `톰캣`은 스레드 풀을 초기화해서 가지고 있다.
  - 모든 HTTP 요청은 이 스레드 풀을 통해 관리한다.
  - 새로운 요청이 들어왔는데 `모든 스레드가 사용 중`이면 그 요청은 `큐`로 들어가 **스레드 하나가 사용 가능한 상태로 풀릴 때까지 기다린다.**
- `전통적인 애플리케이션`에서는 특정 인스턴스에 더 많은 리소스를 추가한다.
- `클라우드 네이티브 애플리케이션`에서는 **수평적 확장** 및 **더 많은 복제본을 배포**한다.

### 3.2.3 내장 톰캣 설정
#### 1. HTTP 포트
- 기본 default 내장서버는 8080포트이다.
- 포트를 지정할 수 있다.
````yaml
server:
  port: 9001
````
#### 2. 연결 타임아웃
- **server.tomcat.connection-timeout** 
  - `tcp 연결 수락`, http 요청을 받기까지 **톰캣이 최대한 기다리는 시간**
  - 서비스 거부 공격(DoS attack)을 방지하는데 도움이 된다.
  - 클라우드에 고도로 분산된 시스템 관점으로 본다면, 연쇄적으로 실패하는 상황을 고려해야한다.
- **server.tomcat.keep-alive-timeout**
  - HTTP요청을 기다리는 동안 연결을 유지하는 시간을 설정할 수 있다.
````yaml
server:
  port: 9001
  tomcat:
    connection-timeout: 2s 
    keep-alive-timeout: 15s
    threads:
      max: 50
      min-spare: 5
````
#### 3. 스레드 풀
- `톰캣`은 요청당 스레드 모델에 따라 요청을 처리하는 `스레드 풀(thread pool)`을 가지고 있다.
- **server.tomcat.threads.max** 속성을 통해, `최대 요청 처리 스레드 수를 설정`할 수 있다.
- **server.tomcat.threads.max** 속성을 통해, `최소의 스레드 수`를 정의할 수 있다.
  - 톰캣이 시작할 때 정의한 갯수 만큼의 스레드가 풀에 생성된다.
- `스레드 풀`에 대한 최상의 설정을 위한 마법같은 공식은 없다.
  - 모니터링을 통해 다양한 설정 값을 시도해봐야 한다.
  - `최대` 200, `최소` 10 이다.

## 3.3 스프링 MVC를 이용한 RESTful 애플리케이션 구축

### 3.3.1 REST API를 먼저, 비지니스 로직은 그다음
#### 1. 도메인 개체 정의
#### 2. 사용 사례 구현
#### 3. 데이터 액세스를 위해 리포지터리 추상화
#### 4. 도메인 오류를 알리기 위한 예외의 사용

### 3.3.2 스프링 MVC를 이용한 REST API 구현
### 3.3.3 데이터 유효성 검사 및 오류 처리
### 3.3.4 미래 요구 사항을 위해 진화하는 API

## 3.4 스프링 RESTful 애플리케이션 테스트
### 3.4.1 JUnit5를 이용한 단위 테스트
### 3.4.2 @SpringBootTest를 통한 통합테스트
### 3.4.3 @WebMvcTest를 사용한 REST 컨틀롤러의 테스트
### 3.4.4 @JsonTest를 사용한 JSON 직렬화 테스트



## Useful Commands

| Gradle Command	         | Description                                   |
|:---------------------------|:----------------------------------------------|
| `./gradlew bootRun`        | Run the application.                          |
| `./gradlew build`          | Build the application.                        |
| `./gradlew test`           | Run tests.                                    |
| `./gradlew bootJar`        | Package the application as a JAR.             |
| `./gradlew bootBuildImage` | Package the application as a container image. |